<!DOCTYPE html PUBLIC "Uncompressed source: https://github.com/rmurphey"><html id="rmurphey-com"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Refactoring setInterval-based polling</title><meta name="description" content="Refactoring setInterval-based polling"/><meta name="HandheldFriendly" content="True"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="twitter:description" content="I came across some code that looked something like this the other day, give or take a few details.
App.Helpers.checkSyncStatus = function() {
  if (App.get(&#39;syncCheck&#39;)) { return; }

  var check = function() {
    $.ajax(&#39;/sync_status&#39;, {
      dataType: &#39;json&#39;,
      success: function(resp) {
        if (resp.status === &#39;done&#39;) {
          App.Helpers.reloadUser(function() {
            clearInterval(App.get(&#39;syncCheck&#39;));
            App.set(&#39;syncCheck&#39;, null);
          });
        }
      }
    });
  };

  App.set(&#39;syncCheck&#39;, setInterval(check, 1000));
};

The code comes from an app whose server-side code queries a third-party service for new data every now and then. When the server is fetching that new data, certain actions on the front-end are forbidden. The code above was responsible for determining when the server-side sync is complete, and putting the app back in a state where those front-end interactions could be allowed again.
You might have heard that setInterval can be a dangerous thing when it comes to polling a server*, and, looking at the code above, it&#39;s easy to see why. The polling happens every 1000 seconds, whether the request was successful or not. If the request results in an error, or fails, or takes more than 1000 milliseconds, setInterval doesn&#39;t care -- it will blindly kick off another request. The interval only gets cleared when the request succeeds and the sync is done."><meta name="twitter:creator" content="@rmurphey"/><meta name="twitter:title" content="Refactoring setInterval-based polling"/><meta name="twitter:site" content="@rmurphey"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/favicon.ico"/><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic,300,800|Source+Code+Pro:400,700,300" rel="stylesheet" type="text/css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/default.min.css"/><style>@media (max-width: 800px) {
  body {
    margin: 5%;
  }
}

@media (min-width: 800px) {
  body {
    margin: 5% 20%;
    font-size: 120%;
  }
}

img.main {
  width: 100%;
}

body {
  font-family: "Open Sans";
  font-weight: 300;
}

p, li {
  line-height: 1.8em;
}

em {
  font-style: italic;
}

strong {
  font-weight: 700;
}

a:hover {
  color: #fb6b70;
}

a:visited {
  color: #9a3337;
}

a {
  color: #d9272e;
  text-decoration: none;
}

pre, code {
  font-family: "Source Code Pro", monospace;
  font-weight: 400;
  font-size: 90%;
}

pre strong, code strong {
  font-weight: 700;
}

h1.banner {
  font-size: 220%;
}

h1.banner span {
  font-weight: 300;
  text-transform: lowercase;
}

h1.banner a {
  color: inherit;
}

.search input[type=submit] {
  margin-left: 1em;
}

.post-content p.date {
  font-style: italic;
}

.post-content span.edit {
  font-size: 80%;
  color: #ccc;
}

.post-content span.edit a {
  color: inherit;
}

.archives ul {
  list-style-type: none;
  text-indent: 0;
  padding: 0;
}

.archives li {
  display: inline-block;
  margin-right: 1em;
}
</style><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-143877-10', 'auto');
ga('send', 'pageview');
</script></head><body id="blog-refactoring-setInterval-polling-page"><h1 class="banner title"><a href="/">rmurphey&nbsp;</a><span><a href="/">Adventures in JavaScript</a></span></h1><nav class="main-nav clearfix subpanel"><form action="https://google.com/search" class="search"><input type="hidden" name="q" value="site:rmurphey.com"/><input type="text" name="q" placeholder="Search for..."/><input type="submit" value="Search"/></form><ul class="post-nav"><li class="home"><a href="/">Home</a></li><li class="next"><a href="/blog/2014/01/01/austin" title="Austin">Next</a></li><li class="prev"><a href="/blog/2013/01/18/onward" title="Onward">Previous</a></li></ul></nav><main role="main" class="content"><article class="post"><h1 class="title"><a href="/2013/02/04/refactoring-setInterval-polling" rel="bookmark" title="Permanent Link: Refactoring setInterval-based polling">Refactoring setInterval-based polling</a></h1><div class="post-content"><p class="date">4 Feb 2013 <span class="edit"> <a href="/2013/02/04/refactoring-setInterval-polling/edit">edit</a></span></p><p>I came across some code that looked something like this the other day, give or take a few details.</p>
<pre><code class="language-javascript">App.Helpers.checkSyncStatus = function() {
  if (App.get(&#39;syncCheck&#39;)) { return; }

  var check = function() {
    $.ajax(&#39;/sync_status&#39;, {
      dataType: &#39;json&#39;,
      success: function(resp) {
        if (resp.status === &#39;done&#39;) {
          App.Helpers.reloadUser(function() {
            clearInterval(App.get(&#39;syncCheck&#39;));
            App.set(&#39;syncCheck&#39;, null);
          });
        }
      }
    });
  };

  App.set(&#39;syncCheck&#39;, setInterval(check, 1000));
};
</code></pre>
<p>The code comes from an app whose server-side code queries a third-party service for new data every now and then. When the server is fetching that new data, certain actions on the front-end are forbidden. The code above was responsible for determining when the server-side sync is complete, and putting the app back in a state where those front-end interactions could be allowed again.</p>
<p>You might have heard that <code>setInterval</code> can be a dangerous thing when it comes to polling a server*, and, looking at the code above, it&#39;s easy to see why. The polling happens every 1000 seconds, <em>whether the request was successful or not</em>. If the request results in an error, or fails, or takes more than 1000 milliseconds, <code>setInterval</code> doesn&#39;t care -- it will blindly kick off another request. The interval only gets cleared when the request succeeds and the sync is done.</p>
<p>The first refactoring for this is easy: switch to using <code>setTimeout</code>, and only enqueue another request once we know what happened with the previous one.</p>
<pre><code class="language-javascript">App.Helpers.checkSyncStatus = function() {
  if (App.get(&#39;syncCheck&#39;)) { return; }

  var check = function() {
    $.ajax(&#39;/sync_status&#39;, {
      dataType: &#39;json&#39;,
      success: function(resp) {
        if (resp.status === &#39;done&#39;) {
          App.Helpers.reloadUser(function() {
            App.set(&#39;syncCheck&#39;, null);
          });
        } else {
          setTimeout(check, 1000);
        }
      }
    });
  };

  App.set(&#39;syncCheck&#39;, true);
};
</code></pre>
<p>Now, if the request fails, or takes more than 1000 milliseconds, at least we won&#39;t be perpetrating a mini-DOS attack on our own server.</p>
<p>Our code still has some shortcomings, though. For one thing, we aren&#39;t handling the failure case. Additionally, the rest of our application is stuck looking at the <code>syncCheck</code> property of our <code>App</code> object to figure out when the sync has completed.</p>
<p>We can use a promise to make our function a whole lot more powerful. We&#39;ll return the promise from the function, and also store it as the value of our <code>App</code> object&#39;s <code>syncCheck</code> property. This will let other pieces of code respond to the outcome of the request, whether it succeeds or fails. With a simple guard statement at the beginning of our function, we can also make it so that the <code>checkSyncStatus</code> function will return the promise immediately if a status check is already in progress.</p>
<pre><code class="language-javascript">App.Helpers.checkSyncStatus = function() {
  var syncCheck = App.get(&#39;syncCheck&#39;);
  if (syncCheck) { return syncCheck; }

  var dfd = $.Deferred();
  App.set(&#39;syncCheck&#39;, dfd.promise());

  var success = function(resp) {
    if (resp.status === &#39;done&#39;) {
      App.Helpers.reloadUser(function() {
        dfd.resolve();
        App.set(&#39;syncCheck&#39;, null);
      });
    } else {
      setTimeout(check, 1000);
    }
  };

  var fail = function() {
    dfd.reject();
    App.set(&#39;syncCheck&#39;, null);
  };

  var check = function() {
    var req = $.ajax(&#39;/sync_status&#39;, { dataType: &#39;json&#39; });
    req.then( success, fail );
  };

  setTimeout(check, 1000);

  return dfd.promise();
};
</code></pre>
<p>Now, we can call our new function, and use the returned promise to react to the <em>eventual outcome</em> of the sync:</p>
<pre><code class="language-javascript">App.Helpers.checkSyncStatus().then(
  // this will run if the sync was successful,
  // once the user has been reloaded
  function() { console.log(&#39;it worked&#39;); },

  // this will run if the sync failed
  function() { console.log(&#39;it failed&#39;); }
);
</code></pre>
<p>With a few more lines of code, we&#39;ve made our function safer -- eliminating the possibility of an out-of-control <code>setInterval</code> -- and also made it vastly more useful to other pieces of the application that care about the outcome of the sync.</p>
<p>While the example above used <a href="http://api.jquery.com/deferred.promise/">jQuery&#39;s promises implementation</a>, there are plenty of other implementations as well, including Sam Breed&#39;s <a href="https://github.com/wookiehangover/underscore.Deferred">underscore.Deferred</a>, which mimics the behavior of jQuery&#39;s promises without the dependency on jQuery.</p>
<p><small>* <a href="http://www.html5rocks.com/en/tutorials/websockets/basics/">Websockets</a> are a great way to eliminate polling all together, but in the case of this application, they weren&#39;t an option.</small></p></div><div class="comments"><h2>Comments</h2><div id="disqus_thread"></div><script>(function() { 
var d = document, s = d.createElement('script');

s.src = '//rmurphey.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();</script></div></article></main><footer class="site-footer clearfix flex subpanel"><div class="flex-item projects"><h2>Projects</h2><ul><li><a href="https://github.com/rmurphey/js-assessment">js-assessment</a></li><li><a href="http://ttlpodcast.com/">TTL Podcast</a></li><li><a href="http://yayquery.com/">yayQuery</a></li></ul></div><div class="flex-item links"><h2>Links</h2><ul><li><a href="/about.html">About</a></li><li><a href="/feed.xml">RSS feed</a></li><li><a href="https://github.com/rmurphey">GitHub</a></li><li><a href="https://twitter.com/rmurphey">Twitter</a></li><li><a href="https://speakerdeck.com/rmurphey">Speaker Deck</a></li></ul></div><div class="flex-item archives"><h2>Archives</h2><ul><li><a href="/archives">All years</a></li><li><a href="/2015">2015</a></li><li><a href="/2014">2014</a></li><li><a href="/2013">2013</a></li><li><a href="/2012">2012</a></li><li><a href="/2011">2011</a></li><li><a href="/2010">2010</a></li><li><a href="/2009">2009</a></li><li><a href="/2008">2008</a></li><li><a href="/2007">2007</a></li></ul></div><div class="flex-item license"><h2>License</h2><p class="vcard">Copyright © 2015 <a class="url fn" href="http://rmurphey.com">Rebecca Murphey</a>.</p><p>All code and content for this blog is available <a href="https://github.com/rmurphey/rmurphey">on GitHub</a>.</p>
</div><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><!--|  
|  
|  Carved up by hand using Harp and a shit load of hacking ❤
|  
|  Also, this:
|  
|  
|  
|                        \_            /;              _.._
|                        `\~--.._     //'            ,(+=\\\\
|                         `//////\  \\/;'             /~ (\\\\
|                           ~/////\~\`)'             /;   ))))
|                               `~'  |              ((`~/((((\
|                               ;'_\'\             /'))   )))))
|                              /~/ '" "'     _.  /'/\_ /^\`((( \
|                             `\/'       _.-~/--/ (  =(   | ,  |
|                                     _/~\_)_}___/^\/~`\.__\|==|
|                                    /uUUU)        )        |  |
|                                   (   / |      _-=o|\__ /'/~ \
|                                   ' /'  |     /(((((\`\(  |~\/
|                                   /'    |   /' )))))"`\`\|/_/---.._,$$,
|                             .,ssS$$$Sss|._/_..-((('    )\)>>>      ~\$
|                          ,sS$$$$$$$$$$$|$$$$$$$  |/    //'~`o        `\
|                        ,$$$$$$$$$$$$$$|$$S$$$$'  (    /                \
|                      ,$$$$$$$$$$$$S$$|$$$$$$$'   |   /              ,s$$$
|                    s$$$$$S$$$$$$$$$S|$$$$$$$$    |  /              $$$$$$
|                  _~,$S""''     ``"S|$$S$$$$$"    (_,`\,          ,$$$$$$$;
|                /~ ,"'             / 'S$$$$$"      \_./|        s$$$$$$$$$$
|             (~'      _,  \==~~)  /     """         \  |       $$$$$$$$$$$$
|              (0\   /0/     \-' /'                   \ |  |  ,$$$$$$$$$$$$$,
|              `/'  '         _-~                     |= \_-\ $$$$$$$$$$$$$$s
|              (~~~)      _.-~_-   \             \  ,s|= |   `"$$$$$$$$$$$$$$$
|             ( `-'  )/>-~  _/-__   |            |,$$$|_/,      `"$$$$$$$$$$$$
|             /V^^^^V~/' _/~/~~  ~~-|            |$$$$$$$$         "$$$$$$$$$$,
|            /  (^^^^),/' /'        )           /S$$$$$$$;         ,$$$$$$$$$$$,
|          ,$$_  `~~~'.,/'         /     _-ss, /(/-(/-(/'        ,s$$$$$$$$$$$$$
|        ,s$$$$$ssSS$$$'         ,$'.s$$$$$$$$'                  (/-(/-(/-(/-(/'
|       S$$$$$$$$$$$$$$        ,$$$$$$$$$$$$$'
|      (/-(/-(/-(/-(/'      _s$$$$$$$$$$$$$$
|                          (/-(/-(/-(/-(/-'
|  
|  
|  
|      – Remy
|  
|  --></footer><!-- Env: production - static files--></body></html>